## Summary

This is a major upgrade prior to the mainnet launch, requiring a state migration and a governance proposal for enactment. It introduces new features, performance enhancements, and critical bug fixes.

### New Features

- **Cosmos SDK ETH Transaction Replacement**

  Users can now replace a transaction with the same nonce in the mempool by submitting a new transaction with a tip that is at least 10% higher.

- **EVM `setcode` Transaction (EIP-7702)**

  This feature introduces support for EIP-7702, enabling a better user experience for our upcoming dApp.

- **EVM Staking Precompile**

  This precompile simplifies proof of delegation, creates more opportunities for our token, and enhances network security.

### Performance Enhancements

- **Sahara IAVL Store Optimization**

  The database schema and indexes have been updated, which requires data migration. Please follow the instructions [here](#how-to-upgrade).

- **EVM Upgrade to v1.16.1**

  This upgrade improves EVM execution performance.

### Bug Fixes

- **Cosmos SDK Voting Power Reduction**

  The decimal precision for voting power calculations has been corrected to 18 (from the default of 8) to prevent incorrect reductions.

- **RPC EVM Custom Error Propagation**

  The RPC layer can now propagate structured errors from the EVM, in addition to the previous `Error(string)` format.

- **`eth_getBlockByNumber` with 'latest' tag returns null**

  Fixed a bug where calling `eth_getBlockByNumber` with the `latest` tag would incorrectly return `null`.

- **Cosmos SDK Block Indexing Failure**

  Resolved an issue where the Cosmos SDK failed to index blocks correctly.

## How to Upgrade

This upgrade requires a state migration. Follow the steps below to upgrade your node.

**1. Update Sahara Chain Daemon**

First, pull the new Docker image for the `v0.3.0` release:

```bash
docker pull ghcr.io/saharalabsai/sahara/saharad:0.3.0-testnet-beta
```

**2. Enable IAVL2**

Ensure that IAVL2 is enabled in your `app.toml` configuration file. This is a required setting for the new version.

```toml
# app.toml
[iavl2]
enable = true
```

**3. Perform State Migration**

Due to database schema and index updates, you must perform a state migration. You can choose one of the following three methods.

### Method 1: Use a Snapshot Archive

You will replace your existing `data` directory with a recent snapshot.

1.  **Choose a snapshot:**
    -   **History Node Archive (2.7T, 6T uncompressed):** Contains the complete history from block `2,600,000` to `5,517,118`.
        ```
        https://storage.googleapis.com/testnet-snapshots/data-55617118.tar.zst
        ```
    -   **Validator Node Archive (94G):** A pruned snapshot at block `5,528,902`.
        ```
        https://storage.googleapis.com/testnet-snapshots/data-5528092-pebbledb-strip.tar.zst
        ```

2.  **Replace your data directory:**
    Download your chosen snapshot, decompress it, and replace your `~/.saharad/data` directory with the contents of the archive.

    > **Important:** Always back up your existing `data` directory before replacing it.

    For history nodes, we recommend using a Btrfs filesystem of at least 4TB with forced Zstandard compression (e.g., `compress-force=zstd:7`) to manage storage growth effectively.

3.  **Configure `pebbledb`:**
    If using a snapshot, ensure your `app.toml` is configured to use `pebbledb` as the backend.

    ```toml
    # app.toml
    app-db-backend = "pebbledb"
    ```

### Method 2: Use the Migration Tool

This method involves using a dedicated tool to migrate your existing data.

1.  **Download the migration tool binary:**
    You can find the binary on the [GitHub releases page](https://github.com/SaharaLabsAI/iavl-migration/releases/tag/v1.0.0).

2.  **Execute the migration:**
    Follow the instructions provided in the [migration tool's README](https://github.com/SaharaLabsAI/iavl-migration?tab=readme-ov-file#1-execute-migration) to perform the migration.

### Method 3: Use StateSync

You can also sync your node from scratch using StateSync. Please note that this process can take a significant amount of time (potentially over 10 hours) to fully restore the state.

Configure your `config.toml` with the following settings:

```toml
# config.toml
rpc_servers = "https://testnet-cos-rpc1.saharalabs.ai,https://testnet-cos-rpc2.saharalabs.ai,https://testnet-cos-rpc3.saharalabs.ai"
trust_height = 5400000
trust_hash = "74FC9E57438D8E7B610EDE195788AB72C42D06322760B3CD3F84B3DC3D25FC28"
trust_period = "168000h0m0s"
```